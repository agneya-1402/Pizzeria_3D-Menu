<!DOCTYPE html>
<html>
<head>
    <title>AR Pizzeria Debug Mode</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; overflow: hidden; font-family: 'Poppins', sans-serif; }

        /* === DEBUG OVERLAY (Shows status on phone screen) === */
        #debug {
            position: absolute;
            top: 10px; left: 10px;
            width: 300px;
            background: rgba(0, 0, 0, 0.85);
            color: #00ff00; /* Hacker Green */
            padding: 15px;
            z-index: 9999;
            font-family: monospace;
            font-size: 14px;
            pointer-events: none;
            border-radius: 8px;
            white-space: pre-wrap; /* Keeps line breaks */
        }

        /* === GREY SCREEN FIXES === */
        .a-canvas { z-index: 1 !important; }
        video { z-index: -1 !important; display: block !important; }

        /* === UI LAYER === */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 1000;
        }

        .header { padding: 20px; display: flex; justify-content: flex-end; pointer-events: auto; }
        .cart-btn { background: white; color: #C8102E; padding: 10px 20px; border-radius: 30px; font-weight: 600; border: none; }
        .info-panel { text-align: center; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.8); margin-top: 40px; }
        .pizza-name { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin: 0; }
        .pizza-price { font-size: 1.2rem; margin-top: 5px; }
        .controls { padding: 40px 20px; display: flex; justify-content: center; gap: 20px; pointer-events: auto; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
        .nav-btn { background: #C8102E; color: white; width: 50px; height: 50px; border-radius: 50%; border: 2px solid white; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .add-btn { background: white; color: #C8102E; padding: 15px 40px; border-radius: 30px; font-weight: 700; border: none; }

        #scan-prompt {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border-radius: 10px;
            z-index: 1001;
        }
    </style>
</head>

<body>

    <div id="debug">System Initializing...<br>Waiting for Camera...</div>

    <div id="ui-layer">
        <div class="header"><button class="cart-btn">Cart <span id="cart-count">0</span></button></div>
        <div class="info-panel">
            <h1 class="pizza-name" id="p-name">Loading...</h1>
            <div class="pizza-price" id="p-price">₹ --</div>
        </div>
        <div class="controls">
            <button class="nav-btn" onclick="changePizza(-1)">←</button>
            <button class="add-btn" onclick="addToCart()">Add To Cart</button>
            <button class="nav-btn" onclick="changePizza(1)">→</button>
        </div>
    </div>

    <div id="scan-prompt">Point camera at the Menu Flyer!</div>

    <a-scene 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;" 
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        vr-mode-ui="enabled: false">
        
        <a-assets>
            <a-asset-item id="pizza-model" src="./assets/scene.gltf"></a-asset-item>
        </a-assets>

        <a-marker type="pattern" url="./marker.patt" id="marker" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
            
            <a-box position="0 0.5 0" scale="0.5 0.5 0.5" material="color: red; opacity: 0.7;"></a-box>

            <a-entity 
                id="pizza-entity"
                gltf-model="#pizza-model" 
                scale="0.5 0.5 0.5" 
                rotation="0 0 0"
                pizza-handler>
            </a-entity>

        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // === LOGGING FUNCTION ===
        function log(text) {
            const d = document.getElementById('debug');
            d.innerHTML += "<br>> " + text;
            console.log(text);
        }

        const pizzaMenu = [
            { name: "Pepperoni Pizza", price: 550 },
            { name: "Margherita", price: 450 },
            { name: "BBQ Chicken", price: 600 },
            { name: "Veggie Supreme", price: 500 }
        ];
        let currentIndex = 0;
        let cartCount = 0;
        let pizzaMeshes = [];

        // === MARKER EVENTS ===
        const marker = document.querySelector("#marker");
        const prompt = document.querySelector("#scan-prompt");

        marker.addEventListener("markerFound", () => {
            prompt.style.display = "none";
            log("MARKER FOUND! (Look for Red Box)");
        });
        marker.addEventListener("markerLost", () => {
            prompt.style.display = "block";
            // log("Marker Lost..."); // Commented out to reduce spam
        });

        // === 3D MODEL LOGIC ===
        AFRAME.registerComponent('pizza-handler', {
            init: function () {
                const el = this.el;
                log("Downloading Model...");
                
                el.addEventListener('model-loaded', () => {
                    log("Model Downloaded Successfully!");
                    const object3D = el.getObject3D('mesh');
                    
                    if (!object3D) {
                        log("ERROR: No Mesh found in GLTF.");
                        return;
                    }

                    object3D.traverse((child) => {
                        if (child.isMesh) {
                            pizzaMeshes.push(child);
                            child.visible = false;
                        }
                    });

                    log("Found " + pizzaMeshes.length + " pizza parts.");
                    
                    if(pizzaMeshes.length > 0) {
                        updatePizzaDisplay();
                    }
                });

                el.addEventListener('model-error', (e) => {
                    log("CRITICAL ERROR: Model failed to load.");
                    log("Check: assets/scene.gltf path?");
                    log(e.detail.src);
                });
            }
        });

        function updatePizzaDisplay() {
            pizzaMeshes.forEach(mesh => mesh.visible = false);
            if(pizzaMeshes[currentIndex]) pizzaMeshes[currentIndex].visible = true;
            
            const data = pizzaMenu[currentIndex % pizzaMenu.length] || {name: "Unknown", price: 0};
            document.getElementById("p-name").innerText = data.name;
            document.getElementById("p-price").innerText = "₹ " + data.price + "/-";
        }

        function changePizza(dir) {
            currentIndex += dir;
            if (currentIndex < 0) currentIndex = pizzaMenu.length - 1;
            if (currentIndex >= pizzaMenu.length) currentIndex = 0;
            updatePizzaDisplay();
        }

        function addToCart() {
            cartCount++;
            document.getElementById("cart-count").innerText = cartCount;
        }

        // Final System Check
        window.onload = function() {
            log("System Ready. Scan Flyer now.");
        };
    </script>
</body>
</html>