<!DOCTYPE html>
<html>
<head>
    <title>AR Pizzeria Menu</title>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Poppins', sans-serif; 
        }

        /* CRITICAL FIX FOR GREY SCREEN: Force video to background */
        .a-canvas {
            z-index: 1 !important;
        }
        video {
            z-index: -1 !important; 
            display: block !important;
        }

        /* UI OVERLAY - Must sit on top of everything */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: rgba(0,0,0,0.1); 
            z-index: 1000; /* High Z-index ensures buttons are clickable */
        }

        /* HEADER */
        .header {
            padding: 20px;
            display: flex;
            justify-content: flex-end;
            pointer-events: auto;
        }
        .cart-btn {
            background: white;
            color: #C8102E; 
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            border: none;
            cursor: pointer;
        }
        .badge {
            background: #C8102E;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* PIZZA INFO */
        .info-panel {
            text-align: center;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            margin-top: 40px;
        }
        .pizza-name {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            font-size: 2.5rem;
            margin: 0;
        }
        .pizza-price {
            font-size: 1.2rem;
            margin-top: 5px;
            font-weight: 300;
        }

        /* BOTTOM CONTROLS */
        .controls {
            padding: 40px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            pointer-events: auto;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        }

        .nav-btn {
            background: #C8102E;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .nav-btn:active { transform: scale(0.9); }

        .add-btn {
            background: white;
            color: #C8102E;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        /* SCAN INSTRUCTION */
        #scan-prompt {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0,0,0,0.6);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            pointer-events: none;
            z-index: 1001;
        }
    </style>
</head>

<body>

    <div id="ui-layer">
        <div class="header">
            <button class="cart-btn">
                Cart <span class="badge" id="cart-count">0</span>
            </button>
        </div>

        <div class="info-panel">
            <h1 class="pizza-name" id="p-name">Loading...</h1>
            <div class="pizza-price" id="p-price">₹ --</div>
        </div>

        <div class="controls">
            <button class="nav-btn" onclick="changePizza(-1)">←</button>
            <button class="add-btn" onclick="addToCart()">Add To Cart</button>
            <button class="nav-btn" onclick="changePizza(1)">→</button>
        </div>
    </div>

    <div id="scan-prompt">Point camera at the Menu Flyer!</div>

    <a-scene 
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;" 
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        vr-mode-ui="enabled: false">
        
        <a-assets>
            <a-asset-item id="pizza-model" src="./assets/scene.gltf"></a-asset-item>
        </a-assets>

        <a-marker type="pattern" url="./marker.patt" id="marker" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5">
            
            <a-entity 
                id="pizza-entity"
                gltf-model="#pizza-model" 
                scale="0.5 0.5 0.5" 
                rotation="0 0 0"
                pizza-handler>
            </a-entity>

        </a-marker>

        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // === PIZZA DATA ===
        const pizzaMenu = [
            { name: "Pepperoni Pizza", price: 550 },
            { name: "Margherita", price: 450 },
            { name: "BBQ Chicken", price: 600 },
            { name: "Veggie Supreme", price: 500 },
            { name: "Hawaiian", price: 520 },
            { name: "Cheese Burst", price: 580 },
            { name: "Mushroom", price: 480 },
            { name: "Spicy Chicken", price: 620 },
            { name: "Meat Lovers", price: 700 },
            { name: "Farmhouse", price: 510 },
            { name: "Tandoori Paneer", price: 530 },
            { name: "Mexican Green", price: 540 }
        ];

        let currentIndex = 0;
        let cartCount = 0;
        let pizzaMeshes = [];

        // === MARKER EVENTS ===
        const marker = document.querySelector("#marker");
        const prompt = document.querySelector("#scan-prompt");

        marker.addEventListener("markerFound", () => {
            prompt.style.display = "none";
        });
        marker.addEventListener("markerLost", () => {
            prompt.style.display = "block";
        });

        // === 3D MODEL HANDLER ===
        AFRAME.registerComponent('pizza-handler', {
            init: function () {
                const el = this.el;
                
                el.addEventListener('model-loaded', () => {
                    const object3D = el.getObject3D('mesh');
                    
                    // Traverse to find all meshes inside the GLTF
                    object3D.traverse((child) => {
                        if (child.isMesh) {
                            pizzaMeshes.push(child);
                            child.visible = false; // Hide initially
                        }
                    });

                    console.log("Pizzas Loaded:", pizzaMeshes.length);
                    
                    if(pizzaMeshes.length > 0){
                        updatePizzaDisplay();
                    } else {
                        console.error("No meshes found in model! Check your GLTF file.");
                    }
                });
            }
        });

        // === UI FUNCTIONS ===
        function updatePizzaDisplay() {
            // Hide all
            pizzaMeshes.forEach(mesh => mesh.visible = false);
            
            // Show current
            // If meshes match pizza count, 1-to-1 mapping
            if(pizzaMeshes[currentIndex]) {
                pizzaMeshes[currentIndex].visible = true;
            }

            // Update Text
            const data = pizzaMenu[currentIndex % pizzaMenu.length];
            document.getElementById("p-name").innerText = data.name;
            document.getElementById("p-price").innerText = "₹ " + data.price + "/-";
        }

        function changePizza(direction) {
            currentIndex += direction;
            
            // Wrap around logic
            if (currentIndex < 0) currentIndex = pizzaMenu.length - 1;
            if (currentIndex >= pizzaMenu.length) currentIndex = 0;

            updatePizzaDisplay();
        }

        function addToCart() {
            cartCount++;
            document.getElementById("cart-count").innerText = cartCount;
            
            const btn = document.querySelector('.add-btn');
            const originalText = btn.innerText;
            btn.innerText = "Added!";
            btn.style.backgroundColor = "#28a745"; // Green feedback
            
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.backgroundColor = "white";
            }, 1000);
        }
    </script>
</body>
</html>